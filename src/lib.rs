// #![warn(missing_docs)]

//! Библиотека для парсинга и конвертации банковских транзакций в различных форматах.
//!
//! Эта библиотека предоставляет парсеры для трёх форматов:
//! - CSV (Comma-Separated Values)
//! - Текстовый формат (key-value pairs)
//! - Бинарный формат (custom binary format)
//!
//! # Основные возможности
//!
//! - Парсинг транзакций из CSV, текстового и бинарного форматов
//! - Запись транзакций в CSV, текстовый и бинарный форматы
//! - Валидация бизнес-правил транзакций
//! - Конвертация между форматами
//! - Сравнение транзакций из разных файлов
//!
//! # Форматы данных
//!
//! ## CSV формат
//! - Первая строка содержит заголовки
//! - Значения разделяются запятыми
//! - Описания экранируются двойными кавычками
//!
//! ## Текстовый формат
//! - Каждая запись состоит из пар "KEY: VALUE"
//! - Поддерживает комментарии (строки, начинающиеся с #)
//! - Пустые строки разделяют записи
//! - Описания должны быть в двойных кавычках
//!
//! ## Бинарный формат
//! - Начинается с магического числа 'YPBN' (0x59 0x50 0x42 0x4E)
//! - Все числа записываются в big-endian порядке
//! - Поддерживает отрицательные суммы
//! - Имеет встроенную проверку целостности

mod binary_format;
mod csv_format;
mod error;
mod txt_format;

pub use binary_format::{BinaryParser, BinaryRecord};
pub use csv_format::CsvParser;
pub use error::ParserError;
pub use txt_format::TextParser;

use std::io::{Read, Write};

/// Трейт для парсинга данных из читаемого потока
///
/// Этот трейт предоставляет единый интерфейс для парсинга
/// данных различных форматов. Каждый парсер должен реализовывать
/// этот трейт для своего формата.
///
/// # Типовой параметр
/// * `R` - Тип читаемого потока, должен реализовывать `Read`
///
pub trait ParseFromRead<R: Read> {
    /// Парсит данные из читаемого потока
    ///
    /// # Аргументы
    /// * `reader` - Читаемый поток
    ///
    /// # Возвращает
    /// * `Ok(Self)` - Успешно распарсенные данные
    /// * `Err(ParserError)` - Ошибка парсинга
    fn parse(reader: &mut R) -> Result<Self, ParserError>
    where
        Self: Sized;
}

/// Трейт для записи данных в записываемый поток
///
/// Этот трейт предоставляет единый интерфейс для записи
/// данных в различных форматах. Каждый парсер должен реализовывать
/// этот трейт для своего формата.
///
/// # Типовой параметр
/// * `W` - Тип записываемого потока, должен реализовывать `Write`
///
/// let mut buffer = Vec::new();
/// CsvParser::write(&transactions, &mut buffer).unwrap();
///
/// let output = String::from_utf8(buffer).unwrap();
/// assert!(output.contains("1001,DEPOSIT"));
/// ```
pub trait WriteTo<W: Write> {
    /// Записывает данные в записываемый поток
    ///
    /// # Аргументы
    /// * `writer` - Записываемый поток
    ///
    /// # Возвращает
    /// * `Ok(())` - Успешная запись
    /// * `Err(ParserError)` - Ошибка записи
    fn write(&self, writer: &mut W) -> Result<(), ParserError>;
}

/// Представляет банковскую транзакцию
///
/// Транзакция содержит все данные о финансовой операции,
/// включая тип, сумму, участников и статус выполнения.
#[derive(Debug, Clone, PartialEq)]
pub struct Transaction {
    /// Уникальный идентификатор транзакции
    ///
    /// Используется для однозначной идентификации операции в системе.
    /// Должен быть уникальным в рамках системы.
    pub tx_id: u64,

    /// Тип транзакции
    ///
    /// Определяет природу финансовой операции.
    pub tx_type: TransactionType,

    /// ID пользователя-отправителя
    ///
    /// Для депозитов всегда равен 0 (система -> пользователь).
    /// Для переводов и выводов должен быть ненулевым.
    pub from_user_id: u64,

    /// ID пользователя-получателя
    ///
    /// Для выводов всегда равен 0 (пользователь -> система).
    /// Для депозитов и переводов должен быть ненулевым.
    pub to_user_id: u64,

    /// Сумма транзакции
    ///
    /// В CSV и текстовом форматах всегда положительная.
    /// В бинарном формате может быть отрицательной для
    /// отражения направления движения средств.
    ///
    /// # Примечание
    /// Для вывода средств рекомендуется использовать положительные значения,
    /// а направление определять по типу транзакции.
    pub amount: i64,

    /// Временная метка транзакции
    ///
    /// Представляет количество миллисекунд с эпохи UNIX
    /// (1 января 1970 года, 00:00:00 UTC).
    pub timestamp: u64,

    /// Статус выполнения транзакции
    ///
    /// Отражает текущее состояние обработки операции.
    pub status: TransactionStatus,

    /// Описание транзакции
    ///
    /// Произвольный текст, описывающий назначение платежа.
    /// Может содержать специальные символы, кавычки и запятые.
    /// В CSV формате экранируется двойными кавычками.
    pub description: String,
}

// lib.rs - добавляем после определения Transaction

/// Обертка для парсинга CSV формата
pub struct CsvTransactions(pub Vec<Transaction>);

/// Обертка для парсинга текстового формата
pub struct TextTransactions(pub Vec<Transaction>);

/// Обертка для парсинга бинарного формата
pub struct BinaryTransactions(pub Vec<Transaction>);

/// Типы банковских транзакций
///
/// Определяет природу финансовой операции и правила валидации.
#[derive(Debug, Clone, Copy, PartialEq)]
pub enum TransactionType {
    /// Депозит (пополнение счёта)
    ///
    /// Деньги поступают от системы к пользователю.
    /// Бизнес-правила:
    /// - `from_user_id` должен быть равен 0
    /// - `to_user_id` должен быть ненулевым
    /// - `amount` должен быть положительным
    Deposit,

    /// Перевод между пользователями
    ///
    /// Деньги переводятся от одного пользователя к другому.
    /// Бизнес-правила:
    /// - `from_user_id` должен быть ненулевым
    /// - `to_user_id` должен быть ненулевым
    /// - `from_user_id` и `to_user_id` не должны совпадать
    /// - `amount` должен быть положительным
    Transfer,

    /// Вывод средств
    ///
    /// Деньги выводятся от пользователя к системе.
    /// Бизнес-правила:
    /// - `from_user_id` должен быть ненулевым
    /// - `to_user_id` должен быть равен 0
    /// - `amount` должен быть положительным
    Withdrawal,
}

/// Статусы выполнения транзакций
///
/// Отражает текущее состояние обработки операции в системе.
#[derive(Debug, Clone, Copy, PartialEq)]
pub enum TransactionStatus {
    /// Транзакция успешно выполнена
    ///
    /// Операция завершена, средства переведены,
    /// все проверки пройдены успешно.
    Success,

    /// Транзакция не выполнена (ошибка)
    ///
    /// Операция не выполнена из-за ошибки:
    /// - недостаточно средств
    /// - техническая ошибка
    /// - нарушение бизнес-правил
    Failure,

    /// Транзакция в процессе обработки
    ///
    /// Операция принята системой, но ещё не обработана.
    /// Может перейти в статус Success или Failure.
    Pending,
}
